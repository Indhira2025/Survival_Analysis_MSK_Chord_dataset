---
title: "MSK_Chorddata_code_project1"
format: html
editor: visual
---

```{r}

library(dplyr)
library(tidyr)
library(data.table)
library(survival)
#library(randomForestSRC)
library(cluster)
#library(survminer)
library(caret)
library(pROC)



# Reading the clinical patient data

clinical_patient <- read.delim("msk_chord_2024_data/data_clinical_patient.txt", 
                   sep = "\t", 
                   skip = 4,
                   header = TRUE,
                   stringsAsFactors = FALSE)
head(clinical_patient)

names(clinical_patient)
typeof(clinical_patient)
#str(clinical_patient)



clinical_patient[clinical_patient$PATIENT_ID == "P-0001340",]
clinical_features <- clinical_patient %>%
  select(PATIENT_ID,
         GENDER,
         RACE,
         ETHNICITY,
         CURRENT_AGE_DEID,
         SMOKING_PREDICTIONS_3_CLASSES,
         OS_MONTHS,
         OS_STATUS)
clinical_features

```

```{r}

library(kableExtra)
clinical_sample <- read.delim("msk_chord_2024_data/data_clinical_sample.txt", comment.char="#")
View(clinical_sample)
kable(table(clinical_sample$CANCER_TYPE))
names (clinical_sample)

#typeof(clinical_sample)
table(clinical_sample$SAMPLE_TYPE)
#str(clinical_sample)
clinical_sample[clinical_sample$SAMPLE_ID == "P-0081657-T01-IM7",]
```

names(timeline_diag)

```{r}
timeline_diag <-  read.delim2("msk_chord_2024_data/data_timeline_diagnosis.txt", 
                   header = TRUE, 
                   sep = "\t", 
                   stringsAsFactors = FALSE)
View(timeline_diag)
#unique(timeline_diag$SUBTYPE)
names(timeline_diag)
#unique(timeline_diag$STAGE_CDM_DERIVED)
#unique(timeline_diag$SUMMARY)
#str(timeline_diag)

## 
timeline_diag$SUMMARY <- trimws(timeline_diag$SUMMARY)


## Determine Baseline Stage at Sequencing & Remove Patients Metastatic at Baseline
non_met_baseline <- timeline_diag %>%
  filter(START_DATE <= 0) %>% # all diagnosis records happened before or at genomic                               #baseline.
  group_by(PATIENT_ID) %>%
  slice_max(START_DATE) %>% #What was the Patient's stage at the time of seqencing?
  filter(STAGE_CDM_DERIVED != "Stage 4" ) %>%
  filter(!SUMMARY %in% c("Distant", "Distant metastases/systemic disease"))
#View(baseline_stage)  
#unique(baseline_stage$SUMMARY)

#at-risk cohort

n_distinct(non_met_baseline$PATIENT_ID)

```

```{r}
library(kableExtra)

timeline_progress <-  read.delim("msk_chord_2024_data/data_timeline_progression.txt"
                                , header = TRUE, 
                                sep = "\t", 
                                stringsAsFactors = FALSE)
View(timeline_progress)
#names(timeline_progress)
#str(timeline_progress)
table(timeline_progress$PROGRESSION)


# patients who cannot be included in a time-to-metastasis analysis because they 
## already had metastasis at the time of sequencing.
pre_baseline_met <- timeline_progress %>%
  filter(
    START_DATE <= 0,
    PROGRESSION == "Y"
  ) %>%
  distinct(PATIENT_ID)

## eligible patients from clinical_patient_data

eligible_patients <- clinical_features %>%
  filter(PATIENT_ID %in% non_met_baseline$PATIENT_ID) %>%  
  # keep only non-metastatic at sequencing
  filter(!PATIENT_ID %in% pre_baseline_met$PATIENT_ID)      
  # remove anyone who had metastasis recorded pre-baseline


# Extracting post-baseline metastasis events

met_events <- timeline_progress %>%
  filter(START_DATE > 0,
         PROGRESSION == "Y") %>%
  group_by(PATIENT_ID) %>%
  summarise(first_met_day = min(START_DATE),
            .groups = "drop")
#View(met_events)


# Extarcting  last follow-up time
last_followup <- timeline_progress %>%
  group_by(PATIENT_ID) %>%
  summarise(last_day = max(START_DATE, na.rm = TRUE),
            .groups = "drop")

#View(last_followup)

#=========================================================================
## Time to metastasis event
ttm_data <- eligible_patients %>%
  left_join(met_events, by = "PATIENT_ID") %>%
  left_join(last_followup, by = "PATIENT_ID") %>%
  mutate(
    event = ifelse(!is.na(first_met_day), 1, 0),
    time  = ifelse(event == 1,
                   first_met_day,
                   last_day)
  ) %>%
  filter(!is.na(time),
         time >= 0)   #The latest recorded event for this patient happened before                        #sequencing. we have no post-sequencing follow-up data.
                      #This patient cannot contribute meaningful survival info
View(ttm_data)
summary(ttm_data$time)
kable(table(ttm_data$event))
ttm_data


===============================================================================

analysis_df <- ttm_data


```

```{r}
#Create a survival object

library(survival)
surv_obj <- Surv(time = analysis_df$time, # creates the correct structure required 
                 event = analysis_df$event) # for RSF or cox regression



```

```{r}

### Mutations dataset

mutations <- read.delim("msk_chord_2024_data/data_mutations.txt", 
                   header = TRUE, 
                   sep = "\t", 
                   stringsAsFactors = FALSE)
#View(mutations)
#names(mutations)
unique(mutations$Variant_Classification)

## keep mutations that change the protein sequence - nonsynonymous mutations




## Mapping tumor barcode sample ID to patient ID byTumor_Sample_Barcode
mutations_clini_merged <- mutations %>%
  left_join(clinical_sample %>% select(Tumor_Sample_Barcode = SAMPLE_ID, PATIENT_ID, TMB_NONSYNONYMOUS ),
            by = "Tumor_Sample_Barcode")
names(mutations_clini_merged)

nonsynonymous_classes <- c(
  "Missense_Mutation",
  "Nonsense_Mutation",
  "Frame_Shift_Del",
  "Frame_Shift_Ins",
  "frameshift_insertion",
  "In_Frame_Del",
  "In_Frame_Ins",
  "Splice_Site",
  "Translation_Start_Site",
  "Nonstop_Mutation",
  "nonsynonymous_SNV"
)


mutations_clini_merged_ns <- mutations_clini_merged %>%
  filter(Variant_Classification %in% nonsynonymous_classes)

mutations_clini_merged_ns
names(mutations_clini_merged_ns)  
  
# selecting top 20 mutated genes
top_genes <- mutations_clini_merged_ns %>%
  count(Hugo_Symbol, sort = TRUE) %>%
  slice_head(n = 20) %>%
  pull(Hugo_Symbol)
top_genes


### Mergeing mutations+clinical sample in clinical patient+ttm

analysis_df_merged <- analysis_df %>%
  left_join(clinical_features, by = "PATIENT_ID")%>%
  left_join(mutations_clini_merged_ns,by = "PATIENT_ID" )

names(analysis_df_merged)
```

```{r}

## Copy number alterations 

cna <- read.table("msk_chord_2024_data/data_cna.txt", 
                   header = TRUE, 
                   sep = "\t", 
                   stringsAsFactors = FALSE)
#View(cna)
names(cna)



library(data.table)
cna_seg <- fread("msk_chord_2024_data/data_cna_hg19.seg")
head(cna_seg)
View(cna_seg)
names(cna_seg)
```

```{r}
sv <- read.delim("msk_chord_2024_data/data_sv.txt", 
                   header = TRUE, 
                   sep = "\t", 
                   stringsAsFactors = FALSE)
View(sv)
names(sv)
```

```{r}
gene_panel <- read.table("msk_chord_2024_data/data_gene_panel_matrix.txt", 
                   header = TRUE, 
                   sep = "\t", 
                   stringsAsFactors = FALSE)
#View(gene_panel)
names(gene_panel)
library(jsonlite)
impact341 <- fromJSON("https://www.cbioportal.org/api/gene-panels/IMPACT341")$genes$hugoGeneSymbol
impact410 <- fromJSON("https://www.cbioportal.org/api/gene-panels/IMPACT410")$genes$hugoGeneSymbol
impact468 <- fromJSON("https://www.cbioportal.org/api/gene-panels/IMPACT468")$genes$hugoGeneSymbol
impact505 <- fromJSON("https://www.cbioportal.org/api/gene-panels/IMPACT505")$genes$hugoGeneSymbol

# Create a lookup list if you want
panel_genes <- list(
  IMPACT341 = impact341,
  IMPACT410 = impact410,
  IMPACT468 = impact468,
  IMPACT505 = impact505
)
panel_genes
```

```{r}
getwd

timeline_progress <-  read.delim("msk_chord_2024_data/data_timeline_progression.txt"
                                , header = TRUE, 
                                sep = "\t", 
                                stringsAsFactors = FALSE)
View(timeline_progress)
names(timeline_progress)
str(timeline_progress)
table(timeline_progress$PROGRESSION)

pre_baseline_met <- timeline_progress %>%
  filter(
    START_DATE <= 0,
    PROGRESSION == "Y"
  ) %>%
  distinct(PATIENT_ID)

clinical_patient <- clinical_patient %>%
  rename(PATIENT_ID = X.Patient.Identifier)

eligible_patients <- clinical_patient %>%
  filter(!PATIENT_ID %in% pre_baseline_met$PATIENT_ID)


met_events <- timeline_progress %>%
  mutate(across(where(is.character), trimws)) %>%
  filter(START_DATE > 0,
         PROGRESSION == "Y") %>%
  group_by(PATIENT_ID) %>%
  summarise(first_met_day = min(START_DATE))

View(met_events)

last_followup <- timeline_progress %>%
  group_by(PATIENT_ID) %>%
  summarise(last_day = max(START_DATE, na.rm = TRUE))
View(last_followup)

ttm_data <- eligible_patients %>%
  left_join(met_events, by = "PATIENT_ID") %>%
  left_join(last_followup, by = "PATIENT_ID") %>%
  mutate(
    event = ifelse(!is.na(first_met_day), 1, 0),
    time  = ifelse(event == 1,
                   first_met_day,
                   last_day)
  )

#View(ttm_data)
summary(ttm_data$time)
table(ttm_data$event)

```

```{r}
TumorSites <- read.delim("msk_chord_2024_data/data_timeline_tumor_sites.txt")
View(TumorSites)
head(TumorSites)
names(TumorSites)
TumorSites[TumorSites$PATIENT_ID == "P-0000012",]
```

```{r}
treatment <- read.delim("msk_chord_2024_data/data_timeline_treatment.txt")
#View(treatment)
head(treatment)
names(treatment)
```

```{r}
radiation <- read.delim("msk_chord_2024_data/data_timeline_radiation.txt")
#View(radiation)
head(radiation)
names(radiation)
```

```{r}
surgery <- read.delim("msk_chord_2024_data/data_timeline_surgery.txt")
head(surgery)
names(surgery)
```

```{r}
prior_meds<- read.delim("msk_chord_2024_data/data_timeline_prior_meds.txt")
#View(prior_meds)
head(prior_meds)
names(prior_meds)
```

```{r}
psa <- read.delim("msk_chord_2024_data/data_timeline_psa_labs.txt")
#View(psa)
head(psa)
names(psa)
```

```{r}


names(clinical_patient)
#str(clinical_patient)
names (clinical_sample)
#str(clinical_sample)
names(timeline_diag)
#str(timeline_diag)
names(cna_seg)

names(mutations)
names(sv)
names(gene_panel)
names(timeline_progress)
names(TumorSites)
names(treatment)
names(radiation)
names(surgery)
names(prior_meds)
names(psa)


str(clinical_patient)
str(clinical_sample)
str(timeline_diag)
str(cna_seg)
str(mutations)
str(sv)
str(gene_panel)
str(timeline_progress)
str(TumorSites)
str(treatment)
str(radiation)
str(surgery)
str(prior_meds)
str(psa)

```
